

{% extends "index_lazy_layout.html" %}

{% block title %}Profireader - Articles{% endblock title %}

{% block portal_content %}


    <script>
        module.controller('article_list', ['$scope', '$ok', '$sce', function ($scope, $ok, $sce) {

            $scope.url_details = {{ raw_url_for('company.material_details')|safe }};
            $scope.url_search_article = {{ raw_url_for('company.materials_load')|safe }};

            $scope.company_id = '{{ company_id }}';


            $scope.page_changed = function () {
                $scope.setFirstPage();
                return false;
            };


            $scope.data = {
                search_text: '',
                pages: {},
                portal_id: null,
                status: null
            };

            $scope.loading = true;
            $scope.typed_text = '';
            $scope.materials = [];
            $scope.portals = [];
            $scope.statuses = [];

            $scope.setFirstPage = function (new_search) {
                var data = $.extend({}, $scope.data);
                if (new_search) {
                    data['search_text'] = new_search;
                }
                $scope.loading = true;

                $ok($scope.url_search_article({company_id: '{{ company_id }}'}), data, function (resp) {
                    $scope.materials = resp['materials'];
                    $scope.portals = resp['portals'];
                    $scope.statuses = resp['statuses'];
                    $scope.data = resp['data']
                }).finally(function () {
                    $scope.loading = false;
                });
            };


            $scope.change_text_color = function (full_text, search_text) {
                var re = new RegExp(search_text, "g");
                {#                full_text = full_text.replace(/#/g, '');#}
                {#                full_text = full_text.replace(re, '#');#}

                return $sce.trustAsHtml(full_text.replace(re, '<span style="color:blue">' + search_text + '</span>'));
            }
        }]);

    </script>
    {#TODO: VK by OZ: Move this template to separatre js file (take look at filemanager templates)#}
    {% include 'company/company_base_angular.html' %}
    {% raw %}
    <div ng-init="setFirstPage({})" ng-controller="article_list">
        <div ng-if="loading">Loading...</div>
        <div ng-if="!loading">
            <table style="width:100%">
                <tr>
                    <th width="250px">Date</th>
                    <th width="250px">Title</th>
                    <th width="250px">Portals</th>
                    <th><p>Status</p></th>
                    <th></th>
                </tr>
                <tr>
                    <td></td>
                    <td><input style="width: 98%" type="text" placeholder="Search" ng-model="search.text"></td>
                    <td>
                        <select style="width: 100%; padding: 5px;" ng-model="data.portal_id"
                                ng-options="port.name for port in portals | orderBy:'id' track by port.id"></select>
                    </td>
                    <td>
                        <select style="width: 100%; padding: 5px;" ng-model="data.status">
                            <option ng-repeat="status in statuses">{{ status }}</option>
                        </select>
                    </td>
                    <td><input ng-click="setFirstPage(typed_text)" type="submit" value="search" style="width: 75%;">
                    </td>

                </tr>
                <tr ng-repeat="material in materials">
                    <td>material.md_tm</td>
                    <td>material.title</td>
                    <td>
                        <div ng-repeat="material_portal_id in material.portals">{{ portals[material_portal_id].name }}
                        </div>
                        <div ng_if="!material.portals.length">{{ _(''not sent) }}</div>
                    </td>
                    <td>material.status</td>
                    <td></td>
                </tr>


            </table>

        </div>

        <div ng-include="'pagination.html'"></div>

    </div>
    {% endraw %}

{% endblock portal_content %}


