{% extends "index_lazy_layout.html" %}

{% block title %}Profireader - Articles{% endblock title %}

{% block portal_content %}


    <script>
        module.controller('article_list', ['$scope', '$ok', '$sce', 'uiGridConstants','uiGridGroupingConstants','$timeout', function ($scope, $ok, $sce, uiGridConstants, uiGridGroupingConstants,$timeout) {

            $scope.url_details = {{ raw_url_for('company.material_details')|safe }};
            $scope.url_search_article = {{ raw_url_for('company.materials_load')|safe }};
            $scope.url_edit_article_portal = {{ raw_url_for('article.article_show_form')|safe }};

            $scope.company_id = '{{ company_id }}';
            $scope.$$translate = {{ translates('article_list')|safe }};

            {% raw %}
            $scope.pos1 = '1';$scope.pos2 = '1';$scope.pos3 = '1';

            $scope.update = function(){
                $scope.paginationOptions.pageNumber = 1;
                $scope.sendData($scope.gridOptions1.columnDefs[0].filter.term,$scope.paginationOptions);
            };

            $scope.refresh = function(){
                $scope.gridOptions1.columnDefs[0].filter.term = '';
                $scope.gridOptions1.columnDefs[2]['filter']['term'] = '1';
                $scope.gridOptions1.columnDefs[3]['filter']['term'] = '1';
                $scope.gridOptions1.columnDefs[4]['filter']['term'] = '1';
                $scope.portal_id = null;
                $scope.status = null;
                $scope.sendData('', $scope.paginationOptions);
            };

            $scope.Filtered = function( row, rowRenderIndex, col, colRenderIndex) {
                if (col.filters[0].term && $scope.load_contr){
                    $scope.paginationOptions.pageNumber = 1;
                    if($scope.gridOptions1.columnDefs[2].filter['term'] == col.filters[0].term && $scope.pos1 != $scope.gridOptions1.columnDefs[2].filter['term']){
                        $scope.pos1 = $scope.gridOptions1.columnDefs[2].filter['term'];
                        $scope.portal_id = $scope.portals[col.filters[0].term - 1]['label'] === '-- all --'? undefined: $scope.portals[col.filters[0].term - 1]['id'];
                        $scope.sendData('', $scope.paginationOptions);
                    }
                    if($scope.gridOptions1.columnDefs[3].filter['term'] == col.filters[0].term && $scope.pos2 != $scope.gridOptions1.columnDefs[3].filter['term']){
                        $scope.pos2 = $scope.gridOptions1.columnDefs[3].filter['term'];
                        $scope.publ_status = $scope.publ_statuses[col.filters[0].term - 1]['label'] === '-- all --'? undefined: $scope.publ_statuses[col.filters[0].term - 1]['label'];
                        $scope.sendData('', $scope.paginationOptions);
                    }
                    if($scope.gridOptions1.columnDefs[4].filter['term'] == col.filters[0].term && $scope.pos3 != $scope.gridOptions1.columnDefs[4].filter['term']){
                        $scope.pos3 = $scope.gridOptions1.columnDefs[4].filter['term'];
                        $scope.status = $scope.statuses[col.filters[0].term - 1]['label'] === '-- all --'? undefined: $scope.statuses[col.filters[0].term - 1]['label'];
                        $scope.sendData('', $scope.paginationOptions);
                    }
                }else{
                    $scope.refresh()
                }
              };

            $scope.sendData = function (new_search_text, c) {
                $scope.loading = true;
                var data = {};
                data.portal_id = $scope.portal_id ? $scope.portal_id : null;
                data.article_id = $scope.article_id ? $scope.article_id : null;
                data.grid_data = {
                    'search_text': (new_search_text !== false) ? new_search_text : $scope.data['search_text'],
                    'status': $scope.status ? $scope.status : null,
                    'new_status': $scope.new_status ? $scope.new_status : null,
                    'publ_status': $scope.publ_status ? $scope.publ_status : null,
                    'page': $scope.paginationOptions.pageNumber,
                    'pageSize': $scope.paginationOptions.pageSize,
                    'sort_date':$scope.paginationOptions.sort
                };
                // TODO: SS by OZ: all data what wee need is presented in resp.data? if yes, y we cant fetch data from there, why we need grid_data?
                $ok($scope.url_search_article({company_id: $scope.company_id}), data, function (resp) {
                    $scope.datas = resp;
                    $scope.gridOptions1.totalItems = resp.total;
                    $scope.portals = resp.portals;
                    $scope.statuses = resp.statuses;
                    $scope.publ_statuses = resp.publ_statuses;
                    for(var m=0;m< $scope.datas.grid_data.length;m++){
                        if($scope.datas.grid_data[m]['level'])
                            $scope.datas.grid_data[m].$$treeLevel = 0
                    }
                    $scope.gridOptions1.columnDefs[2]['filter']['selectOptions'] = $scope.portals;
                    $scope.gridOptions1.columnDefs[3]['filter']['selectOptions'] = $scope.publ_statuses;
                    $scope.gridOptions1.columnDefs[4]['filter']['selectOptions'] = $scope.statuses;
                }).finally(function () {
                    $scope.loading = false;
                    $scope.load_contr = true;
                });
            };

            $scope.gridOptions1 = {
                    data: 'datas.grid_data',
                    paginationPageSizes: [10, 25, 50, 75],
                    paginationPageSize: $scope.paginationOptions.pageSize,
                    enableFiltering: true,
                    useExternalPagination: true,
                    useExternalSorting: true,
                    useExternalFiltering: true,
                    columnDefs: [
                      { name: 'Title', enableSorting: false,enableCellEdit: false, enableColumnMenu: false,
                          width: '35%', cellTemplate: '<div ng-class="link" class="link"><a href="{{ grid.appScope.url_details({company_id:grid.appScope.company_id,article_id:row.entity.id})}}" ng-bind="row.entity.Title"></a></div>',
                          filter: {
                            type: uiGridConstants.filter.INPUT}
                      },
                      { name: 'Date',enableCellEdit: false,enableFiltering: false, groupingShowAggregationMenu: false,
                          groupingShowGroupingMenu: false
                      },
                      { name: 'Portals', enableSorting: false,enableCellEdit: false, enableColumnMenu: false,
                          cellTemplate: '<a href="{{ grid.appScope.url_edit_article_portal({article_portal_division_id: row.entity.id}) }}">{{ row.entity.Portals }}</a>',
                          filter: {
                              term: '1',
                            type: uiGridConstants.filter.SELECT},
                          headerCellClass: $scope.Filtered
                      },
                      { name: 'Publication status', enableSorting: false, enableCellEdit: false, enableColumnMenu: false,
                          filter: {
                            term: '1',
                            type: uiGridConstants.filter.SELECT},
                          headerCellClass: $scope.Filtered
                      },
                      { name: 'Material status', enableSorting: false, editableCellTemplate: '<div><form name="inputForm"><select ng-class="\'colt\' + col.uid" ui-grid-edit-dropdown ng-model="MODEL_COL_FIELD" ng-options="field[editDropdownIdLabel] as field[editDropdownValueLabel] CUSTOM_FILTERS for field in row.entity.allowed_status"></select></form></div>',editDropdownValueLabel: 'value',
                          enableColumnMenu: false,
                          filter: {
                            term: '1',
                            type: uiGridConstants.filter.SELECT},
                          headerCellClass: $scope.Filtered
                      }
                    ],
                    onRegisterApi: function (gridApi) {$scope.setGridExtarnals(gridApi, $scope.sendData, $scope.paginationOptions, $scope.refresh())}
                  };

        }]);
{% endraw %}
    </script>
    {% include 'company/company_base_angular.html' %}
    {% raw %}
    <div ng-init="sendData('', paginationOptions)" ng-controller="article_list">
        <div ng-if="!load_contr">{{_('Loading...')}}</div>
        <div ng-if="load_contr">
        <div ng-show="!areAllEmpty(datas.grid_data)" class="grid" id="grid1" ui-grid-edit ui-grid-grouping ui-grid-pagination ui-grid="gridOptions1" ></div>
        <div ng-show="!loading && areAllEmpty(datas.grid_data)">{{ _('No materials') }}</div>
        <button ng-click="refresh()" ng-show="!loading && areAllEmpty(datas.grid_data)" class="btn btn-warning" >Back</button>
    </div>
    </div>
    {% endraw %}

{% endblock portal_content %}


