{% extends "index_lazy_layout.html" %}

{% block title %}{{ _('Messages') }}{% endblock title %}

{% block head %}
    {{ super() }}
    {% include '_ruslan/partials/_header_files_infinite-scroll.html' %}
{% endblock head %}

{% block portal_content %}

    <style>
        .search-community-row {
            min-height: 120px;
            margin: 10px 0px 5px 0px;
            background-color: #eee;
            padding: 5px;

        }

        .search-community-row button {
            margin-top: 5px;
        }

        .search-community-row div:first-child {
            padding-left: 125px
        }

        .search-community-row img.messenger-avatar {
            width: 120px;
            height: 120px;
            position: absolute;
            left: 0px;
            top: 0px;
            border-radius: 50%;
        }

        .search-community-row img.common-portal-logo {
            width: 3em;
            height: 1em;
            margin-right: 5px;
        }

        .search-community-row img.common-employer-logo {
            width: 3em;
            height: 1em;
            margin-right: 5px;
        }

        .search-community-row .no-common {
            text-align: center;
            font-style: italic;
        }

        .search-community-row .ui-select-highlight {
            color: red;
        }

        .messenger-chat input {
            margin-bottom: 5px;
        }

        .messenger-chat .messenger-chat-contacts li {
            padding-left: 50px;
            padding-top: 12px;
            height: 50px;
        }

        .messenger-chat .messenger-chat-contacts li img.messenger-avatar {
            width: 40px;
            height: 40px;
            position: absolute;
            left: 5px;
            top: 5px;
            border-radius: 50%;
        }

        .messenger-chat ul, li {
            list-style: none;
            padding-left: 0;
        }

        .messenger-chat span.session-name {
            font-size: 7px;
            color: #777;
        }

        .messenger-chat .panel-body {
            height: 30em;
            overflow-x: hidden;
            overflow-y: scroll;
        }

        .messenger-chat .messenger-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

    </style>


    <script>
        module.controller('messenger', ['$scope', '$ok', '$sce', function ($scope, $ok, $sce) {


            $scope.community_search_url = {{ raw_url_for('messenger.community_search')|safe }};
            $scope.contacts_search_url = {{ raw_url_for('messenger.contacts_search')|safe }};
            $scope.contact_action_url = {{ raw_url_for('messenger.contact_action')|safe }};

            $scope.load_chat_url = {{ raw_url_for('messenger.load_chat')|safe }};
            $scope.loading_chatroom_id = null;

            $scope.refresh_chats_url = {{ raw_url_for('messenger.refresh_chats')|safe }};
            $scope.send_message_url = {{ raw_url_for('messenger.send_message')|safe }};


            $scope.$$translate = {{ translates('messages')|safe }};
            $scope.selected_messenger_menu = '';
            $scope.me_user_id = '{{ g.user.id }}';


            $scope.message_text = '';
            $scope.chat_with_user = null;
            $scope.loaded_chats = {};
            $scope.most_recent_message_tm = null;

            $scope.community_search_text = '';
            $scope.community = [];
            $scope.community_next_page = 1;
            $scope.community_loading = false;

            $scope.contacts_search_text = '';
            $scope.contacts = [];
            $scope.contacts_next_page = 1;
            $scope.contacts_loading = false;


            $scope.set_selected_menu = function (selected) {
                if (selected === $scope.selected_messenger_menu) {
                    return false;
                }
                $scope.selected_messenger_menu = selected;

                if (selected === 'community') {
                    $scope.search_community(true);
                }

                if (selected === 'chat') {
                    $scope.search_contacts(true);
                }

            };

            function get_last_message_ids() {
                console.log($scope.loaded_chats);
                return $.map($scope.loaded_chats, function (chat) {
                    var last_message_id = null;
                    if (chat['messages_by_session'].length) {
                        var last_session = chat['messages_by_session'][chat['messages_by_session'].length - 1];
                        last_message_id = last_session['messages'][last_session['messages'].length - 1]['id']
                    }
                    return {
                        'chat_room_id': chat['chat_room_id'],
                        'last_message_id': last_message_id
                    };
                });
            }

            function remove_oldest_loaded_chat() {
                //TODO
                return;
                var loaded_chats_for_users = Object.keys($scope.loaded_chats);
                if (loaded_chats_for_users.length > 19) {
                    var longest_not_viewed = rockets.reduce(function (id_and_last_view_tm, elem) {
                        return timestamp_and_id[0] > elem['last_view'] ? [elem['user']['id'], elem['last_view']] : id_and_last_view_tm;
                    }, [null, Date.now() / 1000.]);
                    delete $scope.loaded_chats[longest_not_viewed[0]];
                }
            }

            function append_messages(messages_by_session) {
                var current_chat = $scope.loaded_chats[messages_by_session['chat_room_id']];
                if (!current_chat) {
                    $scope.loaded_chats[messages_by_session['chat_room_id']] = {
                        'messages_by_session': messages_by_session['messages_by_session'],
                        'there_is_newer': false
                    };
                }
                else {
                    $.each(messages_by_session['messages_by_session'], function (ind, session_from_server) {

                        var existing_session = current_chat['messages_by_session'].find(function (el) {
                            el['session_id'] === session_from_server['session_id']
                        });
                        if (existing_session) {
                            existing_session['messages'].push(session_from_server['messages']);
                        }
                        else {
                            console.log(session_from_server);
                            current_chat['messages_by_session'].push(session_from_server);
                        }
                    })
                }
                $scope.loaded_chats[messages_by_session['chat_room_id']]['users'] = messages_by_session['users']
            }

            $scope.refresh_chats = function () {

            }


            $scope.send_messageaa = function (send_text) {


                (function (load_chat_room_id) {
                    if (load_chat_room_id && $scope.loaded_chats[load_chat_room_id]) {
                        $scope.loaded_chats[load_chat_room_id]['loading'] = true;
                    }
                    $ok($scope.chat_url(), {
                        chat_room_id: load_chat_room_id,
                        text: send_text ? $scope.message_text : null,
                        load_last_messages_for_chat_room: $scope.loaded_chats[load_chat_room_id] ? false : true,
                        client_timezone_shift: new Date().getTimezoneOffset() * 60.,
                        check_for_new_messages_also_for_chat_rooms: get_last_message_ids()
                    }, function (resp) {
                        if (send_text) {
                            $scope.message_text = '';
                        }

                        if (load_chat_room_id && $scope.loaded_chats[load_chat_room_id]) {
                            $scope.loaded_chats[load_chat_room_id]['loading'] = false;
                        }

                        if ($scope.chat_with_user && $scope.chat_with_user['id'] === load_chat_room_id) {
                            if (resp['load_last_messages_for_chat_room']) {
                                $scope.loaded_chats[load_chat_room_id] = resp['load_last_messages_for_chat_room'];
                            }
                        }
                        $.each(resp['check_for_new_messages_also_for_chat_rooms'], function (ind, messages_by_session) {
                            append_messages(messages_by_session);
                            remove_oldest_loaded_chat()
                        })
                    }, function (resp) {

                    });
                })($scope.chat_with_user ? $scope.chat_with_user['id'] : null);
            };

            $scope.remove_oldest_loaded_chat = function () {
                //TODO
                return;
                var loaded_chats_for_users = Object.keys($scope.loaded_chats);
                if (loaded_chats_for_users.length > 19) {
                    var longest_not_viewed = rockets.reduce(function (id_and_last_view_tm, elem) {
                        return timestamp_and_id[0] > elem['last_view'] ? [elem['user']['id'], elem['last_view']] : id_and_last_view_tm;
                    }, [null, Date.now() / 1000.]);
                    delete $scope.loaded_chats[longest_not_viewed[0]];
                }
            };

            $scope.load_chatroom = function (chatroom_id, resp) {
                $scope.loaded_chats[chatroom_id] = {
                    'users': resp['users'],
                    'last_view_tm': Date.now() / 1000.,
                    'chat_room_id': chatroom_id,
                    'there_is_older': resp['there_is_older'] ? resp['there_is_older'] : false,
                    'there_is_newer': resp['there_is_newer'] ? resp['there_is_newer'] : false,
                    'messages': []
                };
            };

            $scope.select_chat_with = function (usr) {
                if (usr === $scope.chat_with_user || $scope.loaded_chats[usr['id']]) { // same user selected or chatroom is loaded
                    return false;
                }
                $scope.chat_with_user = usr;

                var load_chat = function () {
                    if ($scope.loading_chatroom) {
                        return false;
                    }
                    $scope.loading_chatroom = $scope.chat_with_user['id'];
                    $ok($scope.load_chat_url(), {
                        chat_room_id: $scope.loading_chatroom,
                        client_timezone_shift: new Date().getTimezoneOffset() * 60.,
                    }, function (resp) {
                        if ($scope.chat_with_user && $scope.chat_with_user['id'] === $scope.loading_chatroom) {
                            $scope.load_chatroom($scope.loading_chatroom, resp);
                            $scope.append_messages($scope.loading_chatroom, resp['messages']);
                            $scope.remove_oldest_loaded_chat();
                        }
                    }).finally(function () {
                        if ($scope.chat_with_user && $scope.chat_with_user['id'] !== $scope.loading_chatroom) {
                            $scope.loading_chatroom = false;
                            load_chat();
                        }
                        else {
                            $scope.loading_chatroom = false;
                        }
                    });
                };
                load_chat();
            };

            $scope.get_last_message_id_in_sessions = function (messages_by_sessions, first) {
                var last_session = messages_by_sessions[first ? 0 : (messages_by_sessions.length - 1)];
                return last_session['messages'][first ? 0 : (messages_by_sessions.length - 1)]['id']
            };

            $scope.get_last_message_id = function (chatroom_id, first) {
                if (!$scope.loaded_chats[chatroom_id] || !$scope.loaded_chats[chatroom_id]['messages_by_session'].length) {
                    return null;
                }
                return $scope.get_last_message_id_in_sessions($scope.loaded_chats[chatroom_id]['messages_by_session']);
            };

            $scope.add_new_message = function (chat_room_id, message, index, is_new_session) {
                {#                console.log(index);#}
                var message_session_gap = 3600;
                var existing_messages = $scope.loaded_chats[chat_room_id]['messages'];
                var is_gap = function (ind) {
                    if (ind===0) {
                        return true;
                    }
                    console.log(ind, existing_messages[ind]['timestamp'] - existing_messages[ind - 1]['timestamp'], existing_messages[ind]['timestamp'] - existing_messages[ind - 1]['timestamp'] > message_session_gap)
                    return existing_messages[ind]['timestamp'] - existing_messages[ind - 1]['timestamp'] > message_session_gap;
                }


                existing_messages.splice(index, 0, message);


                if (is_gap(index)) {
                    console.log('add session');
                    existing_messages[index]['session'] = {
                        'session_id': message['id'],
                        'session_name': message['id'],
                    }
                }

                if (index > 0 && existing_messages[index - 1]['session'] && is_gap(index)) {
                    console.log('remove session -1');
                    delete existing_messages[index - 1]['session'];
                }
                if (index < existing_messages.length - 1 && existing_messages[index + 1]['session'] && is_gap(index + 1)) {
                    console.log('remove session +1');
                    delete existing_messages[index + 1]['session'];
                }

            }


            $scope.append_messages = function (chat_room_id, messages) {
                {#                debugger;#}

                var current_chat = $scope.loaded_chats[chat_room_id];
                var existing_messages = $scope.loaded_chats[chat_room_id]['messages'];
                $.each(messages, function (message_index, message) {
                    {#                    debugger;#}
                    if (!existing_messages.length) {
                        $scope.add_new_message(chat_room_id, message, 0, true);
                    }
                    else if (existing_messages[0]['id'] > message['id']) {
                        $scope.add_new_message(chat_room_id, message, 0, true);
                    }
                    else if (existing_messages[existing_messages.length - 1]['id'] < message['id']) {
                        $scope.add_new_message(chat_room_id, message, existing_messages.length, true);
                    }
                    else {
                        for (var i = 0; i < existing_messages.length - 1; i++) {
                            if (existing_messages[i]['id'] < message['id'] && existing_messages[i + 1]['id'] > message['id']) {
                                $scope.add_new_message(chat_room_id, message, i + 1, true);
                            }
                        }
                    }

                });
                return;


                var first_message_id = $scope.get_last_message_id(chatroom_id, true);
                var last_message_id = $scope.get_last_message_id(chatroom_id, false);
                $.each(messages_by_session['messages_by_session'], function (ind_session, session_from_server) {
                    var first_message_in_added_session = session_from_server['messages'][0];
                    var last_message_in_added_session = session_from_server['messages'][session_from_server['messages'].length - 1];
                    if (last_message_in_added_session['id'] < first_message_id) {
                        current_chat['messages_by_session'].unshift(session_from_server);
                    }
                    else if (first_message_in_added_session['id'] > last_message_id) {
                        current_chat['messages_by_session'].push(session_from_server);
                    }
                    else {

                    }

                    $.each(session_from_server['messages'], function (ind_message, session_from_server) {

                    })

                    var existing_session = current_chat['messages_by_session'].find(function (el) {
                        el['session_id'] === session_from_server['session_id']
                    });
                    if (existing_session) {
                        {#                                existing_session['messages'].push(session_from_server['messages']);#}
                    }
                    else {
                        if (session_from_server['session_id'] < current_chat['messages_by_session'][0]['session_id']) {

                        }
                        else if (session_from_server['session_id'] > current_chat['messages_by_session'][current_chat['messages_by_session'].length - 1]['session_id']) {

                        }
                        else {
                            for (var i = 0; i < current_chat['messages_by_session'].length; i++) {
                                if (i === current_chat['messages_by_session'] - 1) {
                                    console.error('cant insert session. preset session id are not ordered?');
                                    return;
                                }
                                if (session_from_server['session_id'] > current_chat['messages_by_session'][i]['session_id'] && session_from_server['session_id'] < current_chat['messages_by_session'][i + 1]['session_id']) {
                                    current_chat['messages_by_session'].splice(i, 0, session_from_server);
                                }
                            }
                        }

                    }
                })

                $scope.loaded_chats[messages_by_session['chat_room_id']]['users'] = messages_by_session['users']
            }

            $scope.send_message = function () {
                if ($scope.sending_message_for_chatroom_id) {
                    return false;
                }
                $scope.sending_message_for_chatroom_id = $scope.chat_with_user['id'];

                $ok($scope.send_message_url(), {
                    chat_room_id: $scope.sending_message_for_chatroom_id,
                    last_message_id: $scope.get_last_message_id($scope.sending_message_for_chatroom_id),
                    text: $scope.message_text,
                    client_timezone_shift: new Date().getTimezoneOffset() * 60.,
                }, function (resp) {
                    $scope.message_text = '';
                    $scope.append_messages($scope.sending_message_for_chatroom_id, resp);
                }).finally(function () {
                    $scope.sending_message_for_chatroom_id = false;
                });
            };

            $scope.search_community = function (full_reload) {
                if ($scope.selected_messenger_menu !== 'community') {
                    return;
                }
                if (full_reload) {
                    $scope.community = [];
                    $scope.community_next_page = 1;
                    $scope.community_loading = false;
                }

                if ($scope.community_loading !== false) {
                    return;
                }

                $scope.community_loading = $scope.community_search_text;

                (function f(searched_text) {
                    $ok($scope.community_search_url(), {
                        text: searched_text,
                        page: $scope.community_next_page
                    }, function (resp) {
                        if (searched_text === $scope.community_search_text) {
                            $scope.community.push.apply($scope.community, resp['community'])
                            $scope.community_next_page = resp['next_page'];
                            $scope.community_loading = false;
                        }
                    }, function (resp) {

                    });
                })($scope.community_loading);
            };

            $scope.search_contacts = function (full_reload) {
                if (full_reload) {
                    $scope.contacts = [];
                    $scope.contacts_next_page = 1;
                    $scope.contacts_loading = false;
                }

                if ($scope.contacts_loading !== false) {
                    return;
                }

                $scope.contacts_loading = $scope.contacts_search_text;

                (function f(searched_text) {
                    $ok($scope.contacts_search_url(), {
                        text: searched_text,
                        page: $scope.contacts_next_page
                    }, function (resp) {
                        if (searched_text === $scope.contacts_search_text) {
                            $scope.contacts.push.apply($scope.contacts, resp['contacts'])
                            $scope.contacts_next_page = resp['next_page'];
                            $scope.contacts_loading = false;
                        }
                    }, function (resp) {

                    });
                })($scope.contacts_loading);
            };

            $scope.contact_action = function (user, action) {
                if (user.changing_contact) {
                    return false
                }
                user.changing_contact = true;
                $ok($scope.contact_action_url(), {
                    user_id: user['id'],
                    action: action
                }, function (resp) {
                    user['contact_status'] = resp['contact_status'];
                    user.changing_contact = false;
                }, function (resp) {
                    user.changing_contact = false;
                });

            };

            {% raw %}

        }]);
        {% endraw %}
    </script>


    {% raw %}
    <div ng-controller="messenger" ng-cloak ng-init="set_selected_menu('chat')">

        <div class="container">
            <div class="row reader-list-nav menu-company">
                <div class="col-lg-12">
                    <ul>
                        <li><a ng-click="set_selected_menu('chat')" class="link"
                               ng-class="{'selected': selected_messenger_menu == 'chat'}">{{ _('Messages') }}</a>
                        </li>
                        <li><a ng-click="set_selected_menu('community')" class="link"
                               ng-class="{'selected': selected_messenger_menu == 'community'}">{{ _('Community') }}</a>
                        </li>
                        <li ng-show="0"><a ng-click="set_selected_menu('contacts')" class="link"
                                           ng-class="{'selected': selected_messenger_menu == 'contacts'}">{{
                            _('Contacts')
                            }}</a>
                        </li>
                    </ul>
                </div>
            </div>


            <div class="row mt1em">
                <div class="messenger-chat" ng-show="selected_messenger_menu == 'chat'">
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 messenger-chat-contacts">
                        <input placeholder="{{ _('Search for contact') }}"
                               class="form-control" type="text"
                               ng-model-options='{ debounce: 500 }'
                               ng-change="search_contacts(true)" ng-model="contact_search_text"/>


                        <ul class="list-group">
                            <a href="#" ng-click="select_chat_with(usr)" ng-repeat="usr in contacts">
                                <li class="list-group-item">
                                    <img class="messenger-avatar" pr-image-position="top"
                                         pr-image-url="{{ usr.avatar.url }}"/>
                                    <span ng-bind-html="usr.full_name | highlight: community_search_text"></span>
                                </li>
                            </a>
                        </ul>

                    </div>
                    <div ng-if="!chat_with_user" class="col-lg-8 col-md-8 col-sm-8 col-xs-8">{{ _('please select user to
                        chat with') }}
                    </div>
                    <div ng-if="chat_with_user" class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                        <input ng-if="0 " placeholder="{{ _('Search in chat') }}"
                               class="form-control" type="text"
                               ng-model-options='{ debounce: 500 }'
                               ng-change="search_chat(true)" ng-model="chat_search_text"/>

                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <i class="fa fa-comments"></i>  {{ __('chat with %(full_name)s' , chat_with_user) }}
                            </div>

                            <div class="panel-body">
                                <div ng-if="!loaded_chats[chat_with_user['id']]" class="chat">{{ _('Loading chat') }}
                                </div>
                                <div ng-if="loaded_chats[chat_with_user['id']] && !loaded_chats[chat_with_user['id']]['messages'].length"
                                     class="chat">{{ _('There is no messages in this chat') }}
                                </div>

                                <ul class="chat" ng-if="loaded_chats[chat_with_user['id']]" class="chat-session chat"
                                    schroll-bottom="loaded_chats[chat_with_user['id']]['messages_by_session']">

                                    <li ng-repeat="message in loaded_chats[chat_with_user['id']]['messages']"
                                        ng-class="{'right': message['from_user_id'] == me_user_id, 'left': message['from_user_id'] != me_user_id}"
                                        class="clearfix">
                                        <div ng-if="message.session" class="tac"><span style="color: red;">{{ _('chat session started %(chat_session_start)s', {chat_session_start: moment(message.cr_tm)}) }}</span></div>
                                    <span class="chat-img"
                                          ng-class="{'pull-right': message['from_user_id'] == me_user_id, 'pull-left': message['from_user_id'] != me_user_id}">
                                        <img class="messenger-avatar" pr-image-position="top"
                                             pr-image-url="{{ loaded_chats[chat_with_user['id']]['users'][message['from_user_id']]['avatar']['url'] }}"/>
                                    </span>
                                        <div style="color: #f00; font-size: 8px">{{ moment(message.cr_tm) }}
                                        </div>
                                        <div class="chat-body clearfix">
                                            <div class="header">
                                                <small class=" text-muted"> </small>
                                                <strong class="primary-font"
                                                        ng-class="{'pull-right': message['from_user_id'] == me_user_id, 'pull-left': message['from_user_id'] != me_user_id}">{{
                                                    (message['from_user_id'] ==
                                                    me_user_id)?_('You'):loaded_chats[chat_with_user['id']]['users'][message['from_user_id']]['full_name']
                                                    }}</strong>
                                            </div>
                                            <p>{{ message.content }}</p>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="panel-footer">
                                <div class="input-group">
                                <textarea ng-model="$parent.message_text" id="btn-input" type="text"
                                          ng-disabled="!loaded_chats[chat_with_user['id']] || loaded_chats[chat_with_user['id']]['loading']"
                                          class="form-control input-sm"
                                          placeholder="Type your message here..."></textarea>
                        <span class="input-group-btn">
                            <button ng-disabled="!loaded_chats[chat_with_user['id']] || loaded_chats[chat_with_user['id']]['loading']"
                                    ng-click="send_message(true);"
                                    class="btn btn-warning btn-sm" id="btn-chat">
                                {{ _('Send message') }}</button>
                        </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="messenger-search-community"
                     ng-show="selected_messenger_menu == 'community'"
                     infinite-scroll="search_community()"
                     infinite-scroll-disabled="community_loading !== false || !community_next_page"
                     bak-infinite-scroll-parent="true">

                    <input placeholder="{{ _('Search user with same subscriptions or employment') }}"
                           class="form-control" type="text"
                           ng-model-options='{ debounce: 500 }'
                           ng-change="search_community(true)" ng-model="community_search_text"/>

                    <div ng-repeat="usr in community">
                        <div class="row search-community-row">
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <img class="messenger-avatar" pr-image-position="top"
                                     pr-image-url="{{ usr.avatar.url }}"/>
                                <span ng-bind-html="usr.full_name | highlight: community_search_text"></span>
                                <button class="btn btn-primary w15em"><i class="fa fa-envelope-o"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Send message') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="!usr.contact_status || usr.contact_status == 'ANY_REVOKED' || usr.contact_status == 'REVOKED_ANY'"
                                        ng-click="contact_action(usr, 'add')" class="btn btn-success w15em"><i
                                        class="fa fa-plus"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Add contact') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'ACTIVE_ACTIVE'"
                                        ng-click="contact_action(usr, 'remove')" class="btn btn-danger w15em"><i
                                        class="fa fa-minus"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Remove from contacts') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'REQUESTED_UNCONFIRMED'"
                                        ng-click="contact_action(usr, 'revoke')" class="btn btn-warning w15em"><i
                                        class="fa fa-minus"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Awaiting for confirmation') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'UNCONFIRMED_REQUESTED'"
                                        ng-click="contact_action(usr, 'confirm')" class="btn btn-warning w15em"><i
                                        class="fa fa-plus"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Confirm contact') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'ACTIVE_BANNED'"
                                        class="btn btn-danger w15em"><i
                                        class="fa fa-ban"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Sorry, you are banned by this user') }}
                                </button>
                                <button ng-disabled="usr.changing_contact"
                                        ng-show="usr.contact_status == 'BANNED_ACTIVE'"
                                        ng-click="contact_action(usr, 'unban')" class="btn btn-danger w15em"><i
                                        class="fa fa-ban"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Banned. Remove ban for this user') }}
                                </button>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <i class="fa fa-newspaper-o"></i> {{ _('Common portals subscribed') }}
                                <div class="no-common" ng-if="! usr.common_portals_subscribed.length"><i
                                        class="fa fa-minus-circle red">&nbsp;</i>{{ _('No common portal') }}
                                </div>
                                <div ng-repeat="portal in usr.common_portals_subscribed"><img
                                        class="common-portal-logo"
                                        pr-image-position="left" pr-image-url="{{ portal.logo.url }}"/><a
                                        class="external_link" href="//{{ portal.host }}" target="_blank">{{
                                    portal.name }}<i class="fa fa-external-link ml025em"></i></a>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <i class="fa fa-building-o"></i> {{ _('Common company employers') }}
                                <div class="no-common" ng-if="! usr.common_companies_employers.length"><i
                                        class="fa fa-minus-circle red">&nbsp;</i>{{ _('No common employers') }}
                                </div>
                                <div ng-repeat="company in usr.common_companies_employers"><img
                                        class="common-employer-logo"
                                        pr-image-position="left" pr-image-url="{{ company.logo.url }}"/>{{
                                    company.name }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="w100 btn btn-default mt1em" ng-show="community_next_page"><i
                            class="fa fa-spinner"></i>&nbsp;&nbsp;&nbsp;{{ _('Loading community page') }}
                    </button>
                    <button class="w100 btn btn-default mt1em" ng-show="!community_next_page" disabled="disabled">
                        {{ _('All community users loaded') }}
                    </button>
                    <div ng-show="selected_messenger_menu == 'contacts'">
                        contacts
                    </div>
                </div>

            </div>

        </div>
    </div>
    {% endraw %}
{% endblock portal_content %}
