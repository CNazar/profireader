{% extends "index_lazy_layout.html" %}

{% block title %}{{ _('Messages') }}{% endblock title %}

{% block portal_content %}

    <style>
        .messenger-row {
            min-height: 120px;
            margin: 10px 0px 5px -15px;
            background-color: #eee;
            padding: 5px;

        }

        .messenger-row button {
            margin-top: 5px;
        }

        .messenger-row div:first-child {
            padding-left: 125px
        }

        .messenger-row img.messenger-avatar {
            width: 120px;
            height: 120px;
            position: absolute;
            left: 0px;
            top: 0px;
        }

        .messenger-row img.common-portal-logo {
            width: 3em;
            height: 1em;
            margin-right: 5px;
        }

        .messenger-row img.common-employer-logo {
            width: 3em;
            height: 1em;
            margin-right: 5px;
        }

        .messenger-row .no-common {
            margin-top: 10px;
            text-align: center;
            font-style: italic;
        }

        .messenger-row .ui-select-highlight {
            color: red;
        }
    </style>


    <script>
        module.controller('messenger', ['$scope', '$ok', '$sce', function ($scope, $ok, $sce) {

            {#            angularControllerFunction('MessengerMenuController', 'set_selected_messenger_menu')('messages')#}
            {#            $scope.company_id = '{{ company.id }}';#}
            {#            $scope.company = {{ company.get_client_side_dict()|tojson|safe }};#}

            $scope.community_search_url = {{ raw_url_for('messenger.community_search')|safe }};

            $scope.$$translate = {{ translates('messages')|safe }};
            $scope.selected_messenger_menu = '';
            $scope.community_search_text = '';
            $scope.community = [];
            $scope.community_page = 1;

            $scope.set_selected = function (selected) {
                if (selected === $scope.selected_messenger_menu) {
                    return false;
                }
                if (selected === 'community' && $scope.selected_messenger_menu !== 'community') {
                    $scope.community = [];
                    $scope.search_community();
                }
                $scope.selected_messenger_menu = selected;
            }

            $scope.search_community = function () {

                $ok($scope.community_search_url(), {
                    text: $scope.community_search_text,
                    page: 1
                }, function (resp) {
                    $scope.community = resp['community'];
                    $scope.community_page = resp['page'];
                }, function (resp) {

                })
            }


            {% raw %}

        }]);
        {% endraw %}
    </script>


    {% raw %}
    <div ng-controller="messenger" ng-cloak ng-init="set_selected('community')">

        <div class="container">
            <div class="row menu-company-inside">
                <div class="col-lg-12 menu-messenger">
                    <a ng-click="set_selected('messages')" class="link"
                       ng-class="{'selected': selected_messenger_menu == 'messages'}">{{ _('Messages') }}</a>
                    <a ng-click="set_selected('community')" class="link"
                       ng-class="{'selected': selected_messenger_menu == 'community'}">{{ _('Community') }}</a>
                    <a ng-click="set_selected('contacts')" class="link"
                       ng-class="{'selected': selected_messenger_menu == 'contacts'}">{{ _('Contacts') }}</a>
                </div>
            </div>
            <div class="row">
                <div ng-show="selected_messenger_menu == 'messages'">
                    messages
                </div>
                <div ng-show="selected_messenger_menu == 'community'">
                    <input ng-change="search_community()" ng-model="community_search_text" type="text"/>
                    <div ng-repeat="usr in community">
                        <div class="row messenger-row">
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <img class="messenger-avatar" pr-image-position="top"
                                     pr-image-url="{{ usr.avatar.url }}"/>
                                <span ng-bind-html="usr.full_name | highlight: community_search_text"></span>
                                <button class="btn btn-primary w15em"><i class="fa fa-envelope-o"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Send message') }}
                                </button>
                                <button class="btn btn-success w15em"><i class="fa fa-plus"></i>&nbsp;&nbsp;&nbsp;{{
                                    _('Add contact') }}
                                </button>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <i class="fa fa-newspaper-o"></i> {{ _('Common portals subscribed') }}
                                <div class="no-common" ng-if="! usr.common_portals_subscribed.length"><i
                                        class="fa fa-minus-circle red">&nbsp;</i>{{ _('No common portal') }}
                                </div>
                                <div ng-repeat="portal in usr.common_portals_subscribed"><img
                                        class="common-portal-logo"
                                        pr-image-position="left" pr-image-url="{{ portal.logo.url }}"/><a
                                        class="external_link" href="//{{ portal.host }}" target="_blank">{{
                                    portal.name }}<i class="fa fa-external-link ml025em"></i></a>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                <i class="fa fa-building-o"></i> {{ _('Common company employers') }}
                                <div class="no-common" ng-if="! usr.common_companies_employers.length"><i
                                        class="fa fa-minus-circle red">&nbsp;</i>{{ _('No common employers') }}
                                </div>
                                <div ng-repeat="company in usr.common_companies_employers"><img
                                        class="common-employer-logo"
                                        pr-image-position="left" pr-image-url="{{ company.logo.url }}"/>{{
                                    company.name }}
                                </div>
                            </div>
                        </div>

                        <div class="row">

                        </div>
                    </div>
                </div>

                <div ng-show="selected_messenger_menu == 'contacts'">
                    contacts
                </div>

            </div>

        </div>

    </div>
    {% endraw %}


{% endblock portal_content %}
