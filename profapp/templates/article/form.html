{% extends "index_lazy_layout.html" %}

{% block title %}{{ _('Create article') }}{% endblock title %}

{% block portal_content %}
    {#TODO: VH by OZ remove below line#}
    {% from 'macros.html' import scripts %}
    {{ scripts(names=['croper']) }}

    <script>
        module.controller('article_edit', ['$scope', '$modal', '$af', '$ok', function ($scope, $modal, $af, $ok) {
            $scope.$af = $af;
            $scope.details_article = {{ raw_url_for('article.details')|safe }};
            {% if article_company_id %}
                $scope.save_article = '{{ url_for('article.load_form_create', article_company_id = article_company_id)|safe }}';
            {% else %}
                $scope.save_article = '{{ url_for('article.load_form_create')|safe }}';
            {% endif %}

            $scope.data = {};
            $scope.$$translate = {{ translates('article_edit')|safe }};
            $scope.amidSave = function (resp) {
                window.location.href = $scope.details_article({article_id: resp['article']['article_id']});
                add_message('article was created', 'info', 5000);

            };

            $scope.typeofo = function (o) {
                return (typeof o)
            };

            $scope.getData = function (model, deff) {
                var $image = $('.img-container > img');
                $scope.data.image.coordinates = $image.cropper('getData');
                return deff(model);
            };

            var compile_regexps = function (format_properties) {
                var rem = format_properties['remove_classes_on_apply'] ?
                        RegExp('^' + format_properties['remove_classes_on_apply'] + '$', "i") : false;
                var add = false;
                if (format_properties['add_classes_on_apply']) {
                    add = {};
                    $.each(format_properties['add_classes_on_apply'], function (class_to_add, check_if_not_exust) {
                        add[class_to_add] = RegExp('^' + check_if_not_exust + '$', "i")
                    });
                }
                delete format_properties['add_classes_on_apply'];
                delete format_properties['remove_classes_on_apply'];
                return {remove: rem, add: add};
            };

            var add_or_remove_classes = function (element, classes, remove, add) {

                classes.map(function (class_name) {
                    if (remove && class_name.match(remove)) {
                        $(element).removeClass(class_name);
                    }
                    if (add) {
                        $.each(add, function (add_if_not_exist, check_if_exist) {
                            if (add[add_if_not_exist] && class_name.match(check_if_exist)) {
                                delete add[add_if_not_exist];
                            }
                        });
                    }
                });

                $.each(add, function (add_if_not_exist, check_if_exist) {
                    $(element).addClass(add_if_not_exist);
                })
            };

            var get_array_for_menu_build = function (formats) {
                console.log(formats);
                var ret = [];

                $.each(formats, function (format_group_name, formats_in_group) {
                    var ret1 = {'title': format_group_name, 'items': []};
                    $.each(formats_in_group, function (format_name, format) {
                        ret1['items'].push(
                                {title: format_name.replace(/.*_(\w+)$/, '$1'), format: format_name});
                    });
                    ret.push(ret1);
                });
                return ret;
            };


            var convert_python_format_to_tinymce_format = function (python_format) {

                if (python_format['remove_classes_on_apply'] || python_format['add_classes_on_apply']) {

                    var rem_add = compile_regexps(python_format);

                    python_format['onformat'] = function (DOMUtils, element) {
                        var classes = $(element).attr('class');
                        add_or_remove_classes(element, classes ? classes.split(/\s+/) : [], rem_add['remove'], rem_add['add']);
                    }
                }
                return python_format;
            };


            $scope.tinymceImageOptions['height'] = '450px';

            var general_formats = {{ tinymce_format_groups()|tojson }};
            var custom_formats = {};
            {#            {{  custom_formats = tinymce_format_groups('birdy')|tojson }};#}

            $scope.tinymceImageOptions['formats'] =
                    _.chain($.extend({}, general_formats, custom_formats)). // here we have dicd in form {group_label: {format: format_properties}}
                            reduce(_.extend, {}). // flatten groups
                            map(function (format_properties, format_name) { // convert each format to tinymce in flat dictionary
                                return [format_name, convert_python_format_to_tinymce_format(format_properties)]; // form list of [key, val] pairs
                            }).
                            object(). // convert each [key, val] pair to {key: val} element
                            value(); // get result

            {#            $scope.tinymceImageOptions['pr_formats'] = get_array_for_menu_build(custom_formats);#}
            {#            console.log($scope.tinymceImageOptions['pr_formats']);#}

            $scope.articleImageSelected = function (item) {
                $scope.data.image.image_file_id = item.id;
                {#                $scope.setImageUrl($scope.data.image);#}
                closeFileManager();
                {#                var $image = $('.img-container > img');#}
                {#                $image.cropper('setAspectRatio', $scope.data.image.ratio);#}
            };
            {#            $scope.default_image = true;#}

            $scope.cleanUpHtml = function (data) {
                data.long = cleanup_html(data.long);
                return data;
            };
            {#            $scope.setImageUrl = function (image) {#}
            {#                $scope.image_file_url = fileUrl(image.image_file_id, false, '{{ url_for('static', filename='images/choose_image.jpg') }}');#}
            {#                var image = $scope.image_file_url;#}
            {#                if (image != "{{ url_for('static', filename='images/choose_image.jpg') }}") {#}
            {#                    $scope.default_image = false;#}
            {#                }#}
            {#            };#}
            {#            $scope.change_picture_in_croper = function (coordinates) {#}
            {#                setTimeout(function () {#}
            {#                    init_cropper($scope.data.image.ratio, coordinates);#}
            {#                }, 0);#}
            {#            };#}

            {#            $scope.afterLoad = function (resp, deff) {#}
            {#                var ret = deff(resp);#}
            {#                $scope.setImageUrl($scope['data'].image);#}
            {#                if (!$scope.default_image) {#}
            {#                    $scope.change_picture_in_croper($scope.data.image.coordinates);#}
            {#                }#}
            {#                return ret;#}
            {#            };#}

            $scope.chooseImage = function () {
                $scope.chooseImageinFileManager("parent.angularControllerFunction('article_edit', 'articleImageSelected')");
            };

        }]);

    </script>

    {% raw %}
    <div ng-init="init()" ng-controller="article_edit">
        <h1 class="nice-title">{{ _( !data.article.id?'Create new article':
            (company?'update version of article for company `%(company.name)s`':'update your version of article') )
            }}<span></span></h1>

        <div af af-after-load="afterLoad" af-amid-save="amidSave" af-before-save="getData"
             af-beforeValidate="getData" af-watch="data.article" ng-model="data">

            <div class="update_col1">
                <!-- TODO: OK by OZ:   this block form should share same classes with layout to look MAXIMUM like in portal
                                        maybe layout selector is apporpriate here-->
                {{ _('Article title') }} <span af-validation-answer="data_validation:title"></span>
                <input style="width: 100%" type="text" ng-model="data.article.title">
                {{ _('Short Description') }} <span af-validation-answer="data_validation:short"></span>
                <textarea style="width: 100%" placeholder="{{_('short')}}" ng-model="data.article.short"></textarea>
                {{ _('KeyWords') }} <span af-validation-answer="data_validation:keywords"></span>
                <input style="width: 100%" ng-model="data.article.keywords"/>
            </div>

            <div class="update_col1">
                {{ _('Select picture') }}
                <div ng-include="'cropper.html'"></div>
                <div class="update_col1">
                    {#TODO: OZ by OZ move this code to one file#}
                    <link href="/static/css/article.css" rel="stylesheet">
                    <link href="/static/front/bird/css/article.css" rel="stylesheet">
                    {{ _('Full text') }}
            <textarea ui-tinymce="tinymceImageOptions" style="width: 400px;"
                      ng-model="data.article.long"></textarea>

                </div>

                {#TODO: AA by OZ#}
                <div ng-if="data.article.division" class="update_col1">
                    we have division ({{ data.article.division.name }} - {{ data.article.division.id }})<br/>
                    so tags goes here<br/>
                    TAG TAG TAG!
                </div>


                <div class="update_col1">
                    <input class="create_button"
                           ng-disabled="!$af.isActionAllowed(data, 'save')"
                           ng-click="$af.save(data)"
                           type="submit"
                           value="{{ data.article.id ? _('save') : _('create') }}"/>
                </div>
            </div>
        </div>


        {% endraw %}

    </div>


    <script src="/static/image_editor/demo/js/main.js"></script>
    {#TODO: OZ by OZ move this code to one file#}

{% endblock %}