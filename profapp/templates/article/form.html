<script>

    function fileSelected(selectedfiles) {
        var args = top.tinymce.activeEditor.windowManager.getParams();
        var win = (args.window);
        var input = (args.input);
        $.each(selectedfiles, function (ind, val) {
            win.document.getElementById(input).value = val['url'];
        });
        top.tinymce.activeEditor.windowManager.close();
    }

    module.controller('article_edit', ['$scope', '$ok', '$translate', function ($scope, $ok, $translate) {
        {{ init_data()|safe }}

        $scope.details_article = {{ raw_url_for('article.details')|safe }};
        {% if article_company_id %}
            $scope.save_article = '{{ url_for('article.save', article_company_id = article_company_id)|safe }}';
        {% else %}
            $scope.save_article = '{{ url_for('article.confirm_create')|safe }}';
        {% endif %}


        $scope.afterSave = function (resp) {
            console.log(resp);
            window.location.href = $scope.details_article({article_id: resp['article_id']})
        }

        $scope.getData = function () {
            return $scope.data;
        };


        $scope.tinymceOptions = {
            onChange: function (e) {
                // put logic here for keypress and cut/paste changes
            },
            inline: false,
            plugins: 'advlist autolink link image lists charmap print preview',
            skin: 'lightgray',
            theme: 'modern',
            file_browser_callback: function (field_name, url, type, win) {
                console.log(field_name, url, type, win);
                var cmsURL = '/filemanager/?calledby=tinymce_file_browse_' + type;
                tinymce.activeEditor.windowManager.open({
                    file: cmsURL,
                    title: 'Select an Image',
                    width: 600,  // Your dimensions may differ - toy around with them!
                    height: 600,
                    resizable: "yes",
                    {#                    inline: "yes",  // This parameter only has an effect if you use the inlinepopups plugin!#}
                    close_previous: "yes"
                }, {
                    window: win,
                    input: field_name
                });
            }
        };
    }]);
</script>

{% raw %}
<div ng-controller="article_edit">
    <div ng-if="loading">Loading...</div>
    <div ng-if="!loading">

        <h2 ng-show="!data.id && company">{{ _('Create new article') }}</h2>

        <h2 ng-show="data.id && company">{{ _('update version of article for company `%(company.name)s`', company)
            }}</h2>

        <h2 ng-show="data.id && !company">{{ _('update your version of article') }}</h2>

        <form ng-ok
              ng-onsuccess="afterSave"
              ng-onsubmit="getData"
              ng-action="save_article">
            <input type="hidden" ng-model="data.id">
            {{ _('Article title') }}<br/>
            <input type="text" ng-model="data.title"><br/><br/>

            {{ _('Short Description') }}<br/>
            <textarea placeholder="short" ng-model="data.short"></textarea><br/><br/>

            {{ _('Full text') }}<br/>
            <textarea ui-tinymce="tinymceOptions" placeholder="text" ng-model="data.long"></textarea><br/><br/>
            <input type="submit" value="{{ data.id ? 'save' : 'create' }}">
        </form>
    </div>
</div>

{% endraw %}