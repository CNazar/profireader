{% extends "index_lazy_layout.html" %}

{% block title %}Tags - Profireader{% endblock title %}

{% block portal_content %}
    {% block company_base %}
        {% include 'company/company_base_angular.html' %}
    {% endblock company_base %}
    <script>
        module.controller('portal_tags', function ($scope) {
            angularControllerFunction('CompanyMenuController', 'set_selected_company_menu')('portal_tags');
            $scope.$$translate = {{translates('CompanyProfile') | safe}};


            $scope.data = {};
            $scope.tags_to_remove = {};

            $scope.beforeSave = function (datatosave) {
                datatosave.portal.tags = _.filter(datatosave.portal.tags, function (tag) {
                    return !$scope
                            .tags_to_remove[tag['id']];
                });
                return datatosave;
            };

            $scope.add_tag = function () {
                var newTagId = randomHash();
                $scope.data.portal.tags.push({'id': newTagId, 'tag': $scope.new_tag});
                for (var division_ind = 0; division_ind < $scope.data.portal.divisions.length; division_ind++) {
                    $scope.data.portal.divisions[division_ind].tags[newTagId] = true;
                }
                $scope.new_tag = '';
            }

            $scope.remove_tag = function (tag_id, undo_remove) {
                if (undo_remove) delete $scope.tags_to_remove[tag_id];
                else $scope.tags_to_remove[tag_id] = true;
            }
        });
    </script>
    {% raw %}
    <div ng-controller="portal_tags" ng-cloak>
        <div class="container col-lg-12 col-md-12 col-sm-12 col-xs-12"
             af af-before-save="beforeSave" aaf-after-save="afterSave" aaf-after-load="afterLoad" ng-model="data">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <button class="btn btn-default pull-right border-radius"
                        type="button" ng-click="$af.save(data)"
                        ng-disabled="!$af.isActionAllowed(data, 'save') ">{{ _('Save tags') }}
                </button>
            </div>
            <div class="pr-table col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="pr-row">
                    <div class="pr-cell">tag\division</div>
                    <div class="pr-cell" ng-repeat="division in data.portal.divisions">{{ division.name }}</div>
                    <div class="pr-cell">actions</div>
                </div>
                <div class="pr-row" ng-repeat="tag in data.portal.tags">
                    <div class="pr-cell"><input ng-disabled="tags_to_remove[tag.id]" ng-model="tag.tag"/></div>
                    <div class="pr-cell" ng-repeat="division in data.portal.divisions">
                        <label
                                style="width: 100%"><input
                                ng-checked="division.tags[tag.id]"
                                ng-disabled="tags_to_remove[tag.id]"
                                type="checkbox"/></label></div>
                    <div class="pr-cell" style="width: 10em;">
                        <button ng-if="!tags_to_remove[tag.id]" ng-click="remove_tag(tag.id, false)">Remove</button>
                        <button ng-if="tags_to_remove[tag.id]" ng-click="remove_tag(tag.id, true)">Undo remove</button>
                    </div>
                </div>
            </div>

            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                <button class="btn pull-right border-radius pull-right" ng-click="add_tag()">Add tag</button>
                <input class="pull-right" placeholder="new tag" ng-model="new_tag"/>
            </div>


        </div>
    </div>
    {% endraw %}
{% endblock portal_content %}


