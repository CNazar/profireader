!function(t,e,n){"function"==typeof define?define(n):"undefined"!=typeof module?module.exports=n():e[t]=n(e)}("klass",this,function(t){function e(t){return o.call(n(t)?t:function(){},t,1)}function n(t){return typeof t===r}function i(t,e,n){return function(){var i=this.supr;this.supr=n[u][t];var a={}.fabricatedUndefined,o=a;try{o=e.apply(this,arguments)}finally{this.supr=i}return o}}function a(t,e,a){for(var o in e)e.hasOwnProperty(o)&&(t[o]=n(e[o])&&n(a[u][o])&&l.test(e[o])?i(o,e[o],a):e[o])}function o(t,e){function i(){}function s(){this.initialize?this.initialize.apply(this,arguments):(e||h&&r.apply(this,arguments),c.apply(this,arguments))}i[u]=this[u];var r=this,l=new i,h=n(t),c=h?t:this,d=h?{}:t;return s.methods=function(t){return a(l,t,r),s[u]=l,this},s.methods.call(s,d).prototype.constructor=s,s.extend=o,s[u].implement=s.statics=function(t,e){return t="string"==typeof t?function(){var n={};return n[t]=e,n}():t,a(this,t,r),this},s}t=t||this;var s=t.klass,r="function",l=/.*/,u="prototype";return e.noConflict=function(){return t.klass=s,this},e}),StackExchange.topbar=function(){function t(t){StackExchange.options.enableLogging&&console.log("topbar: "+t)}function e(t){for(var e=0;e<d.length;e++){var n=d[e].$button;if(n&&n[0]==t)return!0}return!1}function n(){for(var t=0;t<d.length;t++)d[t].toggle(!1)}function i(e){var n;if(e&&(n=JSON.parse(e))){t("realtime message - "+e);for(var i in n)for(var a=0;a<d.length;a++)if(i==d[a].name){d[a].handleRealtimeMessage(n[i]);break}}}var a=klass({"name":"","url":"","cssClass":"","button":null,"$dialog":null,"$loadingPlaceholder":null,"$preloadedDialog":null,"hasRead":!1}).statics({"$corral":$(".js-topbar-dialog-corral")}).methods({"isLoading":function(){return null!=this.$loadingPlaceholder},"isLoaded":function(){return null!=this.$dialog},"isVisible":function(){var t=this.$dialog||this.$loadingPlaceholder;return null!=t&&t.is(":visible")},"toggle":function(t,e){if("boolean"!=typeof t)throw new Error("showOrHide is a required parameter");if(!t){if(this.isLoading())return this.showOrHide(!1),void 0;if(!this.isLoaded())return}if(this.isLoaded()||this.isLoading()?(t||e||!this.hasRead||this.markAsRead(),this.showOrHide(t)):this.$preloadedDialog?this.loadChildContent():this.loadDialog(),t)for(var n=0;n<d.length;n++)this.button!=d[n]&&d[n].toggle(!1,e)},"showOrHide":function(t){var e=this.$dialog||this.$loadingPlaceholder;e&&e.toggle(t),t&&this.$dialog&&(this.hasRead=!0)},"loadChildContent":function(){var t=this.$preloadedDialog.find(".child-content");if(this.$dialog=this.$preloadedDialog,this.positionDialogUnderButton(),this.showOrHide(!0),this.url){$("<div>",{"class":"child-content-loading"}).append(StackExchange.helpers.getSpinnerImg()).appendTo(t);var e=this;this.fetchUrl().done(function(n){t.html(n),e.afterLoad()})}},"loadDialog":function(){if(!this.isLoading()){this.$loadingPlaceholder=this.getLoadingPlaceholder().appendTo(a.$corral),this.positionDialogUnderButton(),this.showOrHide(!0);var t=this;this.fetchUrl().done(function(e){if(e.length){t.$dialog=$(e).appendTo(a.$corral),t.afterLoad();var n=t.$loadingPlaceholder.is(":visible");t.positionDialogUnderButton(),t.showOrHide(n)}else StackExchange.helpers.showErrorPopup(t.button.$button.parent(),"An error occurred while loading - please try again.")}).fail(function(t,e,n){console.log(n)}).always(function(){t.$loadingPlaceholder.remove(),t.$loadingPlaceholder=null})}},"afterLoad":function(){},"getLoadingPlaceholder":function(){var t=$("<div/>").append(StackExchange.helpers.getSpinnerImg()).html(),e=['<div class="topbar-dialog ',this.cssClass,' dno">','<div class="header">',t,"</div>",'<div class="modal-content"/>',"</div>"];return $(e.join(""))},"positionDialogUnderButton":function(){var t=this.button.$button.outerHeight(),e=this.button.$button.offset().left-d[0].$button.offset().left;(this.$dialog||this.$loadingPlaceholder).css({"top":t,"left":e})},"fetchUrl":function(){t("fetching "+this.url);var e=$.ajax({"type":"GET","url":this.url,"dataType":"html"});return e},"markAsRead":function(){this.button.markAsRead(),this.isLoaded()&&this.$dialog.find(".unread-item").removeClass("unread-item")},"handleRealtimeMessage":function(){this.clearLoadedDialog()},"clearLoadedDialog":function(){this.isLoaded()&&(this.$dialog.remove(),this.$dialog=null,this.hasRead=!1)}}),o=klass({"name":"","selector":"","dialog":null,"$button":null,"onClass":"","unreadCountPrefix":"","queuedUnreadCount":0,"showsOnMouseOver":!1}).methods({"initialize":function(){this.dialog.name=name,this.dialog.button=this,g.push(this.dialog);var t=this;this.$button=$(this.selector),this.$button.click(function(){return t.toggle(),!1}),this.showsOnMouseOver&&this.$button.mouseover(function(){t.showOnMouseOver()}),this.onClass="topbar-icon-on"+(this.onClass?" ":"")+this.onClass},"toggle":function(t,e){t="boolean"==typeof t?t:!this.$button.hasClass(this.onClass),this.$button.toggleClass(this.onClass,t),this.dialog.toggle(t,e)},"showOnMouseOver":function(){for(var t=!1,e=0;e<d.length;e++){var n=d[e];if(n!=this&&n.showsOnMouseOver&&n.isOn()){t=!0;break}}t&&this.toggle(!0,!0)},"isOn":function(){return this.$button.hasClass(this.onClass)},"markAsRead":function(){this.$button.find(".unread-count").fadeOut();var t=this.$button.data("unread-class");t&&this.$button.removeClass(t),this.dequeuePendingUnreadCount()},"dequeuePendingUnreadCount":function(){this.queuedUnreadCount&&(this.setUnreadCount(this.queuedUnreadCount),this.queuedUnreadCount=0,this.dialog.clearLoadedDialog())},"setUnreadCount":function(t){if(void 0===t);else if(0>=t)this.queuedUnreadCount=0,this.isOn()||this.markAsRead();else if(t>0)if(this.isOn())this.queuedUnreadCount=t;else{var e=this.$button.find(".unread-count");e.text(this.unreadCountPrefix+t).fadeIn(),this.addUnreadClass(),this.dialog.clearLoadedDialog()}},"addUnreadClass":function(){var t=this.$button.data("unread-class");t&&this.$button.addClass(t)},"handleRealtimeMessage":function(){}}),s=a.extend({"url":"/topbar/site-switcher","cssClass":"siteSwitcher-dialog","$searchItems":null}).methods({"afterLoad":function(){this.$dialog.find("#js-site-filter-txt").typeWatch({"highlight":!1,"wait":250,"captureLength":-1,"callback":$.proxy(this.filterSites,this)}),this.$searchItems=this.$dialog.find(".js-other-sites li").clone().map(function(){return{"title":$(".site-icon",this).attr("title").toLowerCase(),"description":$(".site-desc",this).text().toLowerCase(),"hostname":$("a",this).first().attr("href"),"li":this}});var t=this.$dialog;this.$dialog.find("#js-site-filter-txt").focus(function(){var e=t.offset().top+t.height(),n=t.find(".other-sites li:nth-child(2)"),i=n.offset().top+n.height();i>e&&t.animate({"scrollTop":t.scrollTop()+i-e},750)}),this.supr()},"doSearch":function(t,e){var n;e=e.toLowerCase();var i=[];return $.each(t,function(t,n){var a={"index":t,"li":n.li,"item":n},o=n.title.indexOf(e);n.title==e?a.priority=1:0==o?a.priority=2:o>-1?a.priority=3:n.description.indexOf(e)>-1?a.priority=4:n.hostname.indexOf(e)>-1&&(a.priority=5),a.priority&&i.push(a)}),n=i.sort(function(t,e){return t.priority-e.priority||t.index-e.index})},"filterSites":function(t){var e=$(".js-other-sites"),n=this.$searchItems;e.empty(),""!=t&&(n=this.doSearch(n,t,!0)),e.append(n.map(function(t){return this&&this.li||t.li}))}}),r=o.extend({"name":"SiteSwitcher","selector":".js-site-switcher-button","dialog":new s,"showsOnMouseOver":!0,"onClass":"icon-site-switcher-on"}),l=a.extend({"url":"/topbar/inbox","cssClass":"inbox-dialog"}),u=o.extend({"name":"Inbox","selector":".js-inbox-button","dialog":new l,"showsOnMouseOver":!0}).methods({"handleRealtimeMessage":function(t){this.setUnreadCount(t.UnreadInboxCount)}}),h=a.extend({"url":"/topbar/achievements","cssClass":"achievements-dialog"}).methods({"afterLoad":function(){this.alignRep(),this.bindDateGroupToggles(),this.displayUtcTime(),this.supr()},"alignRep":function(){var t=this.$dialog.find(".js-items .js-faux-column"),e=0;t.filter(".js-rep-change").each(function(){var t=$.trim($(this).text()).length;t>e&&(e=t)}),e>0&&t.width(6*e)},"bindDateGroupToggles":function(){this.$dialog.find(".js-date-group-toggle").click(function(){var t=$(this),e=t.closest(".js-date-group"),n=e.find(".js-items"),i=e.find(".rep-site-container");t.find(".date-group-toggle").toggleClass("toggle-hidden"),n.add(i).fadeToggle("fast")}),this.$dialog.find(".rep-site-container").on("click",function(t){t.stopImmediatePropagation()})},"displayUtcTime":function(){var t=this.$dialog,e=function(){var e=new Date;e.setTime(e.getTime()+1e3*StackExchange.options.serverTimeOffsetSec);var n=e.getUTCHours(),i=e.getUTCMinutes();10>n&&(n="0"+n),10>i&&(i="0"+i),t.find(".js-utc-time").text(n+":"+i)};e(),setInterval(e,6e4)}}),c=o.extend({"name":"Achievements","selector":".js-achievements-button","dialog":new h,"unreadCountPrefix":"+","showsOnMouseOver":!0}).methods({"handleRealtimeMessage":function(t){var e=0===(t.UnreadRepCount||0)&&t.UnreadNonRepCount>0;e?this.addUnreadClass():this.setUnreadCount(t.UnreadRepCount)}}),d=[],g=[];return{"init":function(){window.devicePixelRatio>=1.5&&$(".js-avatar-me").attr("src",function(t,e){return e.replace("?s=24","?s=48")});var t=new u,i=new c;d.push(new r),d.push(t),d.push(i),$(document).click(function(t){e(t.target)||$.contains(a.$corral[0],t.target)||n()}),$.get("/topbar/get-unread-counts",function(e){e&&(t.handleRealtimeMessage(e),i.handleRealtimeMessage(e))})},"hideAll":n,"handleRealtimeMessage":i}}();